---
- name: AWS CloudWatch Agent | Include OS-specific variables
  include_vars: "{{ ansible_distribution }}.yml"
  with_first_found:
    - "{{ ansible_distribution }}.yml"
    - "empty.yml"
  tags: aws_cw_agent

- name: AWS CloudWatch Agent | Set dependencies
  set_fact:
    amz_cwagent_dependencies: "{{ __amz_cwagent_dependencies }}"
  when: amz_cwagent_dependencies is not defined
  tags: aws_cw_agent

- name: AWS CloudWatch Agent | Set signature URL
  set_fact:
    amz_cwagent_sig_url: "{{ __amz_cwagent_sig_url }}"
  when: amz_cwagent_sig_url is not defined
  tags: aws_cw_agent

- name: AWS CloudWatch Agent | Set package URL
  set_fact:
    amz_cwagent_pkg_url: "{{ __amz_cwagent_pkg_url }}"
  when: amz_cwagent_pkg_url is not defined
  tags: aws_cw_agent

- name: AWS CloudWatch Agent | Ensure dependencies are installed
  package:
    name: "{{ amz_cwagent_dependencies }}"
    state: latest
  tags: aws_cw_agent

- command: echo ~
  register: home_dir
  tags: aws_cw_agent

- set_fact: amz_cwagent_pubkey_path="{{ home_dir.stdout }}/{{ amz_cwagent_pubkey_url | basename }}"
  tags: aws_cw_agent

- set_fact: amz_cwagent_sig_path="{{ home_dir.stdout }}/{{ amz_cwagent_sig_url | basename }}"
  tags: aws_cw_agent

- set_fact: amz_cwagent_pkg_path="{{ home_dir.stdout }}/{{ amz_cwagent_pkg_url | basename }}"
  tags: aws_cw_agent

- block:
    - name: AWS CloudWatch Agent | Download GPG pubkey
      get_url:
        url: "{{ amz_cwagent_pubkey_url }}"
        dest: "{{ amz_cwagent_pubkey_path }}"
        force: yes

    - name: AWS CloudWatch Agent | Download signature file
      get_url:
        url: "{{ amz_cwagent_sig_url }}"
        dest: "{{ amz_cwagent_sig_path }}"
        force: yes

    - name: AWS CloudWatch Agent | Download package file
      get_url:
        url: "{{ amz_cwagent_pkg_url }}"
        dest: "{{ amz_cwagent_pkg_path }}"
        force: yes

    - name: AWS CloudWatch Agent | Import GPG pubkey
      command: >
        gpg --no-greeting --no-auto-check-trustdb -q --batch --no-tty --import {{ amz_cwagent_pubkey_path }}
      register: amz_cwagent_pubkey_import_check
      changed_when: no
      failed_when: amz_cwagent_pubkey_import_check.rc != 0

    - name: AWS CloudWatch Agent | Verify GPG pubkey
      shell: >
        gpg --with-colons --fingerprint "Amazon CloudWatch Agent" | awk -F":" '$1 == "fpr" {print $10;}'
      args:
        executable: /bin/bash
      register: amz_cwagent_pubkey_fingerprint_reported
      changed_when: no
      failed_when: amz_cwagent_pubkey_fingerprint_reported.stdout != amz_cwagent_pubkey_fingerprint

    - name: AWS CloudWatch Agent | Verify package file
      command: >
        gpg --no-greeting --no-auto-check-trustdb -q --batch --no-tty --verify {{ amz_cwagent_sig_path }} {{ amz_cwagent_pkg_path }}
      register: amz_cwagent_pkg_check
      changed_when: no
      failed_when: amz_cwagent_pkg_check.rc != 0

    - name: AWS CloudWatch Agent | Install package
      include_tasks: "{{ ansible_distribution }}.yml"

  always:
    - name: AWS CloudWatch Agent | Cleanup downloaded files
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "{{ amz_cwagent_pubkey_path }}"
        - "{{ amz_cwagent_sig_path }}"
        - "{{ amz_cwagent_pkg_path }}"
      changed_when: no
      ignore_errors: yes
  tags: aws_cw_agent
